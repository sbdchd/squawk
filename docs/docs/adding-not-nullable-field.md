---
id: adding-not-nullable-field
title: adding-not-nullable-field
---

Use a check constraint instead of setting a column as `NOT NULL`.

:::note Postgres Version

In Postgres versions 11 of later, adding a non-null column with a default will complete without a table scan.
:::

## problem

Adding a column as `NOT NULL` requires a table scan and the `ALTER TABLE` requires
an `ACCESS EXCLUSIVE` lock. Reads and writes will be disabled while this statement is running.

## solutions

### adding a non-nullable column

Add a column as nullable and use a check constraint to verify integrity. The check constraint should be added as `NOT NULL` and then validated.

Instead of:

```sql
ALTER TABLE "core_recipe" ADD COLUMN "foo" integer DEFAULT 10 NOT NULL;
```

Use:

```sql
ALTER TABLE "core_recipe" ADD COLUMN "foo" integer DEFAULT 10;
ALTER TABLE "core_recipe" ADD CONSTRAINT foo_not_null
    CHECK ("foo" IS NOT NULL) NOT VALID;
-- backfill column so it's not null
ALTER TABLE "core_recipe" VALIDATE CONSTRAINT foo_not_null;
```

Add the column as nullable, add a check constraint as `NOT VALID` to verify new rows and updates are, backfill the column so it no longer contains null values, validate the constraint to verify existing rows are valid.

See ["How not valid constraints work"](constraint-missing-not-valid.md#how-not-valid-validate-works) for more information on adding constraints as `NOT VALID`.

### setting an existing column as non-nullable

Instead of:

```sql
ALTER TABLE "core_recipe" ALTER COLUMN "foo" SET NOT NULL;
```

Use:

```sql
ALTER TABLE "core_recipe" ADD CONSTRAINT foo_not_null
    CHECK ("foo" IS NOT NULL) NOT VALID;
-- backfill column so it's not null
ALTER TABLE "core_recipe" VALIDATE CONSTRAINT foo_not_null;
```

Add a check constraint as `NOT VALID` to verify new rows and updates are, backfill the column so it no longer contains null values, validate the constraint to verify existing rows are valid.

See ["How not valid constraints work"](constraint-missing-not-valid.md#how-not-valid-validate-works) for more information on adding constraints as `NOT VALID`.


## solution for alembic and sqlalchemy

### adding a non-nullable column

Instead of:

```python
import sqlalchemy as sa

class AlembicValidateMigration(BaseModel):
    __tablename__ = "alembic_validate_migration"
    ...
    add_some_not_nullable_field = sa.Column(sa.BigInteger, default=10, nullable=False)
    ...
```

Use:

```python
# models.py
import sqlalchemy as sa

class AlembicValidateMigration(BaseModel):
    __tablename__ = "alembic_validate_migration"
    __table_args__ = (
        sa.CheckConstraint(
            "add_some_not_nullable_field IS NOT NULL",
            name="add_some_not_nullable_field_is_not_null",
        )
    )
    ...
    add_some_not_nullable_field = sa.Column(sa.BigInteger, default=10, nullable=True)
    ...
```

Create alembic migration manually, 
because alembic not creates migration for constraints automatically https://github.com/sqlalchemy/alembic/issues/508 
```python
# migrations/*.py
# First migration
from alembic import op
import sqlalchemy as sa

def schema_upgrades():
    """schema upgrade migrations go here."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "alembic_validate_migration",
        sa.Column("add_some_not_nullable_field", sa.BigInteger(), nullable=True),
    )
    op.create_check_constraint(
        constraint_name="add_some_not_nullable_field_is_not_null",
        table_name="alembic_validate_migration",
        condition="add_some_not_nullable_field IS NOT NULL",
        postgresql_not_valid=True,
    )
    # ### end Alembic commands ###


def schema_downgrades():
    """schema downgrade migrations go here."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(
        constraint_name="add_some_not_nullable_field_is_not_null",
        table_name="alembic_validate_migration",
        type_="check",
    )
    op.drop_column("alembic_validate_migration", "add_some_not_nullable_field")
    # ### end Alembic commands ###
```

Create alembic migration to validate the constraint
```python
# migrations/*.py
# Second migration
import sqlalchemy as sa
from alembic import op

def schema_upgrades():
    """schema upgrade migrations go here."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute(
        sa.text(
            """ALTER TABLE alembic_validate_migration VALIDATE CONSTRAINT add_some_not_nullable_field_is_not_null"""
        ),
    )
    # ### end Alembic commands ###


def schema_downgrades():
    """schema downgrade migrations go here."""
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###
```

### setting an existing column as non-nullable

Instead of:

Change `nullable=True` to `nullable=False`

Use:

Add CheckConstraint
```python
# models.py
import sqlalchemy as sa

class AlembicValidateMigration(BaseModel):
    __tablename__ = "alembic_validate_migration"
    __table_args__ = (
        sa.CheckConstraint(
            "add_some_not_nullable_field IS NOT NULL",
            name="add_some_not_nullable_field_is_not_null",
        )
    )
    ...
    add_some_not_nullable_field = sa.Column(sa.BigInteger, default=10, nullable=True)
    ...
```

Create alembic migration manually, 
because alembic not creates migration for constraints automatically https://github.com/sqlalchemy/alembic/issues/508 
```python
# migrations/*.py
# First migration
from alembic import op

def schema_upgrades():
    """schema upgrade migrations go here."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_check_constraint(
        constraint_name="add_some_not_nullable_field_is_not_null",
        table_name="alembic_validate_migration",
        condition="add_some_not_nullable_field IS NOT NULL",
        postgresql_not_valid=True,
    )
    # ### end Alembic commands ###


def schema_downgrades():
    """schema downgrade migrations go here."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(
        constraint_name="add_some_not_nullable_field_is_not_null",
        table_name="alembic_validate_migration",
        type_="check",
    )
    # ### end Alembic commands ###
```

Create alembic migration to validate the constraint
```python
# migrations/*.py
# Second migration
import sqlalchemy as sa
from alembic import op

def schema_upgrades():
    """schema upgrade migrations go here."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute(
        sa.text(
            """ALTER TABLE alembic_validate_migration VALIDATE CONSTRAINT add_some_not_nullable_field_is_not_null"""
        ),
    )
    # ### end Alembic commands ###


def schema_downgrades():
    """schema downgrade migrations go here."""
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###
```
