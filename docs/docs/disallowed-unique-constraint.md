---
id: disallowed-unique-constraint
title: disallowed-unique-constraint
---

## problem

Adding a `UNIQUE` constraint requires an `ACCESS EXCLUSIVE` lock which blocks reads and writes to the table while the index is built.


## solution

Instead create an index `CONCURRENTLY` and create the `CONSTRAINT` `USING` the index.

<https://www.postgresql.org/docs/current/sql-altertable.html>

Instead of:

```sql
-- blocks reads and writes to table_name while constraint is validated.
ALTER TABLE distributors ADD CONSTRAINT dist_id_uniq UNIQUE (dist_id);
```

Use:

```sql
-- allows reads and writes while index is built
CREATE UNIQUE INDEX CONCURRENTLY dist_id_uniq ON distributors (dist_id);
```


## solution for alembic and sqlalchemy

Instead of:

```python
# models.py
import sqlalchemy as sa

class AlembicValidateMigration(BaseModel):
    __tablename__ = "alembic_validate_migration"
    ...
    field_with_unique_constr = sa.Column(sa.BigInteger, unique=True)
    ...
```

Use:

```python
# models.py
import sqlalchemy as sa

class AlembicValidateMigration(BaseModel):
    __tablename__ = "alembic_validate_migration"
    ...
    field_with_unique_constr = sa.Column(sa.BigInteger, unique=True, index=True)
    ...
```

```python
# migrations/*.py
from alembic import op

def schema_upgrades():
    """schema upgrade migrations go here."""
    # ### commands auto generated by Alembic - please adjust! ###
    with op.get_context().autocommit_block():
        op.create_index(
            op.f("ix_alembic_validate_migration_field_with_unique_constr"),
            "alembic_validate_migration", 
            ["field_with_unique_constr"], 
            unique=True, 
            postgresql_concurrently=True,
        )
    # ### end Alembic commands ###


def schema_downgrades():
    """schema downgrade migrations go here."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f("ix_alembic_validate_migration_field_with_unique_constr"), table_name="alembic_validate_migration")
    # ### end Alembic commands ###
```
