---
id: require-concurrent-index-deletion
title: require-concurrent-index-deletion
---

## problem

A normal `DROP INDEX` acquires an `ACCESS EXCLUSIVE` lock on the table, blocking other accesses until the index drop can be completed. 

## solution

Ensure all index deletions use the `CONCURRENTLY` option. `CONCURRENTLY` waits until conflicting transactions have completed.

<https://www.postgresql.org/docs/10/sql-dropindex.html>

### drop index

Instead of:

```sql
-- blocks reads and writes to table
DROP INDEX "app"."email_idx";
```

Use:

```sql
-- allows reads and writes to table while Postgres waits for conflicting transactions to finish
DROP INDEX CONCURRENTLY "app"."email_idx";
```


## solution for alembic and sqlalchemy

Instead of:

```python
# migrations/*.py
from alembic import op

def schema_upgrades():
    """schema upgrade migrations go here."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index("ix_alembic_validate_migration_field_with_index", table_name="alembic_validate_migration")
    # ### end Alembic commands ###


def schema_downgrades():
    """schema downgrade migrations go here."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_index("ix_alembic_validate_migration_field_with_index", "alembic_validate_migration", ["field_with_index"], unique=False)
    # ### end Alembic commands ###
```

Use:

```python
# migrations/*.py
from alembic import op

def schema_upgrades():
    """schema upgrade migrations go here."""
    # ### commands auto generated by Alembic - please adjust! ###
    with op.get_context().autocommit_block():
        op.drop_index(
            "ix_alembic_validate_migration_field_with_index",
            table_name="alembic_validate_migration",
            postgresql_concurrently=True
        )
    # ### end Alembic commands ###


def schema_downgrades():
    """schema downgrade migrations go here."""
    # ### commands auto generated by Alembic - please adjust! ###
    with op.get_context().autocommit_block():
        op.create_index(
            op.f("ix_alembic_validate_migration_field_with_index"),
            "alembic_validate_migration",
            ["field_with_index"],
            unique=False,
            postgresql_concurrently=True
        )
    # ### end Alembic commands ###
```
