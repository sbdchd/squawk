---
id: require-concurrent-index-creation
title: require-concurrent-index-creation
---

## problem

During a normal index creation, table updates are blocked, but reads are still allowed. `CONCURRENTLY` avoids locking the table against writes during index creation.

<https://www.postgresql.org/docs/current/sql-createindex.html#SQL-CREATEINDEX-CONCURRENTLY>

## solution

Ensure all index creations use the `CONCURRENTLY` option.

This rule ignores indexes added to tables created in the same transaction.

### create index

Instead of:

```sql
-- blocks writes to table while index is built
CREATE INDEX "email_idx" ON "app_user" ("email");
```

Use:

```sql
-- allows reads and writes while index is built
CREATE INDEX CONCURRENTLY "email_idx" ON "app_user" ("email");
```


## solution for alembic and sqlalchemy

Instead of:

```python
# models.py
import sqlalchemy as sa

class AlembicValidateMigration(BaseModel):
    __tablename__ = "alembic_validate_migration"
    ...
    field_with_index = sa.Column(sa.BigInteger, index=True)
    ...
```

Use:

```python
# models.py
import sqlalchemy as sa

class AlembicValidateMigration(BaseModel):
    __tablename__ = "alembic_validate_migration"
    ...
    field_with_index = sa.Column(sa.BigInteger, index=True)
    ...
```

```python
# migrations/*.py
from alembic import op

def schema_upgrades():
    """schema upgrade migrations go here."""
    # ### commands auto generated by Alembic - please adjust! ###
    with op.get_context().autocommit_block():
        op.create_index(
            op.f("ix_alembic_validate_migration_field_with_index"), 
            "alembic_validate_migration", 
            ["field_with_index"], 
            unique=False, 
            postgresql_concurrently=True
        )
    # ### end Alembic commands ###


def schema_downgrades():
    """schema downgrade migrations go here."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f("ix_alembic_validate_migration_field_with_index"), table_name="alembic_validate_migration")
    # ### end Alembic commands ###
```

**Notes:**

In a concurrent index build, the index is actually entered as an “invalid” 
([details](https://www.postgresql.org/docs/current/sql-createindex.html#:~:text=In%20a%20concurrent%20index%20build,modified%20the%20table%20to%20terminate.))
